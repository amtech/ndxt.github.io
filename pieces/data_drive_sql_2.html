<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>动机</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/47.3c660fb3.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/26.10a40be6.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/30.8c2f80d9.js"><link rel="prefetch" href="/assets/js/31.3881f235.js"><link rel="prefetch" href="/assets/js/32.68859a3e.js"><link rel="prefetch" href="/assets/js/33.8bba4ee1.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/36.0a2188a4.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/39.eb7ebd4d.js"><link rel="prefetch" href="/assets/js/40.2b2b571a.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="active sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_4.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="sidebar-link">/pieces/framework_7.html</a></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="sidebar-link">动机</a></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="动机"><a href="#动机" aria-hidden="true" class="header-anchor">#</a> 动机</h1><p>上一节讲了sql语句的拼接方式，参数驱动sql设计一个重要的目标就是让用户收集的前端输入 能够直接作为转换程序的输入参数。 但是前端输入的参数在类型、格式方面和sql语句需要的参数肯定有很多不一致的地方。前端一般输入的式字符串，sql语句要求的可能式日期、数字、字符串匹配模板甚至是一个用于in语句的数组。所以参数驱动sql设计了一套参数预处理系统。这样在业务系统中就不需要编写输入参数的转换代码，同时可以通过变更参数驱动sql来改变参数的处理方式，这样也增加了系统的灵活性。</p><h1 id="设计思想"><a href="#设计思想" aria-hidden="true" class="header-anchor">#</a> 设计思想</h1><p>参数的语法为 ： <strong>参数引用描述符：(预处理指令列表)SQL语句变量名称</strong>；上一节也有介绍。
预处理指令列表，使用逗号分开的多个预处理指令；指令按照顺序执行，不区分大小写。预处理会按照顺序执行。预处理的主要作用有：类型转换、查询模式生产、语句替换等等。详细预处理列表参见 <a href="https://github.com/ndxt/centit-commons/blob/master/centit-database/src/main/java/com/centit/support/database/utils/QueryUtils.java" target="_blank" rel="noopener noreferrer">QueryUtils.java</a>。</p><h1 id="使用示例"><a href="#使用示例" aria-hidden="true" class="header-anchor">#</a> 使用示例</h1><pre class="language-java"><code>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token punctuation">&gt;</span></span> paramsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;punitCode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;createDate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2010-12-01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mathName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;江苏 先腾&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;array&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1,2,3,4,5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;uu.unitType asc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String queryStatement <span class="token operator">=</span>
                <span class="token string">&quot;select uu.unitCode,uu.unitName,uu.unitType,uu.isValid,uu.unitTag&quot;</span>
                        <span class="token operator">+</span><span class="token string">&quot;  from projectTable uu  &quot;</span>
                        <span class="token operator">+</span><span class="token string">&quot; where 1=1 [:(SPLITFORIN,LONG,CREEPFORIN)array| and uu.unitType in (:array)]&quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;[:(date)createDate | and uu.createDate &gt;= :createDate ]&quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;[:(like)mathName | and uu.unitName like :mathName ]&quot;</span>
                        <span class="token operator">+</span><span class="token string">&quot;[:(inplace)sort | order by :sort  ]&quot;</span><span class="token punctuation">;</span>

        <span class="token function">printQueryAndNamedParams</span><span class="token punctuation">(</span>QueryUtils<span class="token punctuation">.</span><span class="token function">translateQuery</span><span class="token punctuation">(</span>
                 queryStatement<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                  paramsMap<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>上面的代码输出结果为：</p><pre class="language-text"><code>--- sql语句
select uu.unitCode,uu.unitName,uu.unitType,uu.isValid,uu.unitTag  
from projectTable uu   
where 1=1  and uu.unitType in (:array_0,:array_1,:array_2,:array_3,:array_4)
 and uu.createDate &gt;= :createDate 
 and uu.unitName like :mathName order by uu.unitType asc
--- 参数Map为
array_1----2
array_0----1
array_3----4
array_2----3
array----[1, 2, 3, 4, 5]
array_4----5
mathName----%江苏%先腾%
createDate----Wed Dec 01 00:00:00 CST 2010
</code></pre><h1 id="详细预处理指令"><a href="#详细预处理指令" aria-hidden="true" class="header-anchor">#</a> 详细预处理指令</h1><pre class="language-java"><code> <span class="token comment">/**
     * 表示这个参数不需要
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_NO_PARAM <span class="token operator">=</span> <span class="token string">&quot;NP&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化为模式匹配字符串,字符串中间的空格、tab都会被%替换
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_LIKE <span class="token operator">=</span> <span class="token string">&quot;LIKE&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 用于like语句，只在参数后面添加一个 %， MySql建议只用这个，其他的匹配方式在MySql中效率都比较低
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_STARTWITH <span class="token operator">=</span> <span class="token string">&quot;STARTWITH&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 用于like语句，只在参数前面添加一个 %
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_ENDWITH <span class="token operator">=</span> <span class="token string">&quot;ENDWITH&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化为日期类型,
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_DATE <span class="token operator">=</span> <span class="token string">&quot;DATE&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化为日期类型，并且计算第二天的日期，没有时间（时间为00:00:00） 用于区间查询的结束时间
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_NEXTDAY <span class="token operator">=</span> <span class="token string">&quot;NEXTDAY&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化为带时间的，日期的类型
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_DATETIME <span class="token operator">=</span> <span class="token string">&quot;DATETIME&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化为 2016-6-16这样的日期字符串
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_DATESTR <span class="token operator">=</span> <span class="token string">&quot;DATESTR&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化为 2016-6-16 10:25:34这样的日期和时间字符串
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_DATETIMESTR <span class="token operator">=</span> <span class="token string">&quot;DATETIMESTR&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 过滤掉所有非数字字符
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_DIGIT <span class="token operator">=</span> <span class="token string">&quot;DIGIT&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 大写
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_UPPERCASE <span class="token operator">=</span> <span class="token string">&quot;UPPERCASE&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 小写
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_LOWERCASE <span class="token operator">=</span> <span class="token string">&quot;LOWERCASE&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化为符合数字的字符串，
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_NUMBER <span class="token operator">=</span> <span class="token string">&quot;NUMBER&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 给子符串添加''使其可以拼接到sql语句中，并避免sql注入
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_QUOTASTR <span class="token operator">=</span> <span class="token string">&quot;QUOTASTR&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 应该转化 Integer类型，单对于数据库来说他和long没有区别所以也返回的Long类型
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_INTEGER <span class="token operator">=</span> <span class="token string">&quot;INTEGER&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化 Long 类型
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_LONG <span class="token operator">=</span> <span class="token string">&quot;LONG&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 转化为 Double 类型
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_FLOAT <span class="token operator">=</span> <span class="token string">&quot;FLOAT&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 将对象转换为 String， 如果是数组用 ','连接。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_STRING <span class="token operator">=</span> <span class="token string">&quot;STRING&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 将字符串 用,分割返回 String[]；对于支持数组变量的spring jdbcTemplate或者hibernate中的hql用这个处理就可以了，先腾实现的jpa也支持数组参数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_SPLITFORIN <span class="token operator">=</span> <span class="token string">&quot;SPLITFORIN&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/** 对于不支持数组参数的执行引擎，需要将参数按照数值的格式进行扩展
     * 修改语句中的 命名参数，使其能够接受 多个参数以便用于in语句，比如： in(:a)
     * 传入a为一个数组，会根据a的实际长度变为 in(:a0,:a1,a2,......)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_CREEPFORIN <span class="token operator">=</span> <span class="token string">&quot;CREEPFORIN&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 将参数值 拼接到 sql对应的参数位置，同时要避免sql注入；一般用与Order by中
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_INPLACE <span class="token operator">=</span> <span class="token string">&quot;INPLACE&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 过滤参数中的html标签
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SQL_PRETREAT_ESCAPE_HTML <span class="token operator">=</span> <span class="token string">&quot;ESCAPEHTML&quot;</span><span class="token punctuation">;</span>
</code></pre></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/data_drive_sql_1.html" class="prev">
          动机
        </a></span><span class="next"><a href="/pieces/data_drive_sql_3.html">
          动机
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/47.3c660fb3.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
