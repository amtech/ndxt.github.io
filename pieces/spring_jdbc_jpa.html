<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>动机</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/26.10a40be6.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/30.8c2f80d9.js"><link rel="prefetch" href="/assets/js/31.3881f235.js"><link rel="prefetch" href="/assets/js/32.68859a3e.js"><link rel="prefetch" href="/assets/js/33.8bba4ee1.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/36.0a2188a4.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/39.eb7ebd4d.js"><link rel="prefetch" href="/assets/js/40.2b2b571a.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/47.3c660fb3.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_4.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="sidebar-link">/pieces/framework_7.html</a></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="active sidebar-link">动机</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#lazy-懒加载" class="sidebar-link">Lazy 懒加载</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#valuegenerator-值生成器" class="sidebar-link">ValueGenerator 值生成器</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#get" class="sidebar-link">get*</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#list" class="sidebar-link">list*</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#query" class="sidebar-link">query*</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#save" class="sidebar-link">save*</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#update" class="sidebar-link">update*</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#merge" class="sidebar-link">merge*</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#cascade" class="sidebar-link">*  Cascade *</a></li><li class="sidebar-sub-header"><a href="/pieces/spring_jdbc_jpa.html#fetch" class="sidebar-link">fetch*</a></li></ul></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="动机"><a href="#动机" aria-hidden="true" class="header-anchor">#</a> 动机</h1><p>主流的Orm框架有Hibernate、Mybatis和Spring Data。以往我一直推荐使用Hibernate，使用jpa注解不需要写sql语句也不要配置文件，确实比较便捷。说hibernate效率低下，主要式指用hibernate进行查询和统计，我觉得这是不公平的，查询可以原生sql直接返回jsonarry来做，没有必要用hibernate的orm模型做。hibernate功能确实强大，换一个方式来说也就是很难娴熟的掌握，光是对象的三种状态就把一半人搞晕。所以现在我也不推荐大家使用了，没有必要在持久化层花费太多尽力学习。MyBatis现在用的人越来越多，但是比较烦它的配置文件越来越讨厌xml格式的配置文件。Spring Data接触的较少；但是到时有很多人用spring jdbc。<a href="https://ndxt.github.io/" target="_blank" rel="noopener noreferrer">先腾框架</a>中<a href="https://github.com/ndxt/centit-persistence" target="_blank" rel="noopener noreferrer">持久化模块</a>中有三个自摸库分别对Hibernate、Mybatis和spring jdbc进行了封装，让开发人员可以选择不同的技术，但使用的接口有尽量统一。</p><p>这篇博文主要将用jdbc实现jpa，这个作用就是将使用jdbc的方式和hibernate一样，jpa的标准就是jboss提供的。<a href="https://github.com/ndxt/centit-commons/tree/master/centit-database/src/main/java/com/centit/support/database/orm" target="_blank" rel="noopener noreferrer">工程源码</a>。先腾的Orm只实现了数据库增删改查的基本操作，没有实现缓存之类的额外特性。是JPA的一个最常用的子集，在系统开发的实践中验证过能够满足一般业务系统的开发需求。</p><h1 id="jpa注解扩展"><a href="#jpa注解扩展" aria-hidden="true" class="header-anchor">#</a> jpa注解扩展</h1><p>JPA注解已经很全，但是一些细节不太满意，对其进行了扩展。</p><h2 id="lazy-懒加载"><a href="#lazy-懒加载" aria-hidden="true" class="header-anchor">#</a> Lazy 懒加载</h2><p>JPA的关联注解（OneToMany、ManyToOne）中FetchType有lazy懒加载的选项。Lob字段的默认也是懒加载的，但是感觉并不是直观。 所以添加了一个Lazy注解，用于字段Column属性，明确的标注这个字段为懒加载，而不考虑这个字段是否式lob字段，任何类型都可以懒加载。
另外，所以的关联关系都是默认懒加载的，并且无法修改这个默认属性，如果需要同步加载，在调用方法中需要明确说明，这样避免没有必要的性能消耗。</p><h2 id="valuegenerator-值生成器"><a href="#valuegenerator-值生成器" aria-hidden="true" class="header-anchor">#</a> ValueGenerator 值生成器</h2><p>JPA 有一个注解GeneratedValue 这个式用于主键的，并且不够灵活，所以定义了一个ValueGenerator注解，这个注解并不要一定用在主键上，任何字段都可以，可以把它作为insert 或者 update 的前置触发器。</p><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span>METHOD<span class="token punctuation">,</span> FIELD<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">ValueGenerator</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 数值生成方式 
     *   Auto 数据库自动增长、 SEQUENCE 序列 value中保存序列名称 、
     *   UUID 、 CONSTANT 常量 value中保存常量、
     *   FUNCTION 公式 value中保存公式，是一个四则运算表达式，可以通过变量引用这个对象的其他属性
     * @return GeneratorType
     */</span>
    GeneratorType <span class="token function">strategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> GeneratorType<span class="token punctuation">.</span>AUTO<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 数值生成时机 NEW （insert） UPDATE （update） READ （select）
     * @return GeneratorTime
     */</span>
    GeneratorTime <span class="token function">occasion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> GeneratorTime<span class="token punctuation">.</span>NEW<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 生成条件 IFNULL 数值为空时生成 ALWAYS 总是生成，会覆盖已有的值
     * @return GeneratorCondition
     */</span>
    GeneratorCondition <span class="token function">condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> GeneratorCondition<span class="token punctuation">.</span>IFNULL<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 具体生成参数 对应 GeneratorType 不同有不用的意思
     * @return
     */</span>
    String <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>需要特别说明的式strategy =  GeneratorType.FUNCTION 非常灵活可以通过对象的其他属性计算得出这个字段的值，这时value中的值为<a href="https://blog.csdn.net/code_fan/article/details/81352458" target="_blank" rel="noopener noreferrer">四则运算表达式</a>。使用示例：</p><pre class="language-java"><code><span class="token comment">/**
     * UPDATEDATE(更新时间) 更新时间
     */</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;UPDATE_DATE&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ValueGenerator</span><span class="token punctuation">(</span> strategy<span class="token operator">=</span> GeneratorType<span class="token punctuation">.</span>FUNCTION<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;today()&quot;</span><span class="token punctuation">,</span> 
		    condition <span class="token operator">=</span> GeneratorCondition<span class="token punctuation">.</span>ALWAYS<span class="token punctuation">,</span> occasion <span class="token operator">=</span> GeneratorTime<span class="token punctuation">.</span>ALWAYS <span class="token punctuation">)</span>
    <span class="token keyword">private</span> Date  updateDate<span class="token punctuation">;</span>
</code></pre><p>这个注解的意思就是只要这个对象有更新，updateDate字段就更新为当前日期，代码中无需对这个字段赋值。</p><h1 id="元数据-jpametadata"><a href="#元数据-jpametadata" aria-hidden="true" class="header-anchor">#</a> 元数据 JpaMetadata</h1><p>JpaMetadata 中维护了类和数据库表结构的对应关系，在第一次使用到这个类的时候收集类上的注解信息，并将其保存在JpaMetadata中。每次访问数据库就是根据这个元数据来生成sql语句。框架中 JsonObjectDao 类实现了不同数据库之间的方言，这个不是本文的重点，有兴趣的可以看一下，欢迎给出宝贵建议。</p><h1 id="jpa的增删改查具体实现-ormdaoutils"><a href="#jpa的增删改查具体实现-ormdaoutils" aria-hidden="true" class="header-anchor">#</a> JPA的增删改查具体实现 OrmDaoUtils</h1><p>OrmDaoUtils 中所有的方法都需要传递一个connection 数据库连接参数。其中的方法分以下几类：</p><h2 id="get"><a href="#get" aria-hidden="true" class="header-anchor">#</a> get*</h2><p>getObject* 就是获取一个对象的查询。</p><h2 id="list"><a href="#list" aria-hidden="true" class="header-anchor">#</a> list*</h2><p>listObjects* 就是更加属性查询一组对象，可以分页查询。</p><h2 id="query"><a href="#query" aria-hidden="true" class="header-anchor">#</a> query*</h2><p>queryObjects* 是更加sql语句查询，这个相对更加灵活，可以分页查询。</p><h2 id="save"><a href="#save" aria-hidden="true" class="header-anchor">#</a> save*</h2><p>save* Object * 保存新对象。</p><h2 id="update"><a href="#update" aria-hidden="true" class="header-anchor">#</a> update*</h2><p>updateObject 更改对象。</p><h2 id="merge"><a href="#merge" aria-hidden="true" class="header-anchor">#</a> merge*</h2><p>mergeObject 合并对象，可以理解为insert Or Update。</p><h2 id="cascade"><a href="#cascade" aria-hidden="true" class="header-anchor">#</a> *  Cascade *</h2><p>方法名中有Cascade单词的，表示会级联查询，就是会根据OneToMany、OneToOne等等关联关系查询关联表。</p><h2 id="fetch"><a href="#fetch" aria-hidden="true" class="header-anchor">#</a> fetch*</h2><p>fetch* 方法为获取Lazy对应的字段。</p><h1 id="持久化框架考虑"><a href="#持久化框架考虑" aria-hidden="true" class="header-anchor">#</a> 持久化框架考虑</h1><p>在<a href="https://ndxt.github.io/" target="_blank" rel="noopener noreferrer">先腾框架</a>中<a href="https://github.com/ndxt/centit-persistence" target="_blank" rel="noopener noreferrer">持久化模块</a>中spring jdbc模块中，对这写方法进行了再次封装，将JdbcTemplate中的数据库链接传递给OrmDaoUtils，这样就不需要connection这个参数了，参见<a href="https://github.com/ndxt/centit-persistence/blob/master/centit-persistence-jdbc/src/main/java/com/centit/framework/jdbc/dao/BaseDaoImpl.java" target="_blank" rel="noopener noreferrer">BaseDaoImpl源码</a>。</p></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/sort_as_tree.html" class="prev">
          问题
        </a></span><span class="next"><a href="/projects/">
          项目总体介绍
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/26.10a40be6.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
