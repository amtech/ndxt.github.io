<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>动机</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/33.8bba4ee1.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/26.10a40be6.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/30.8c2f80d9.js"><link rel="prefetch" href="/assets/js/31.3881f235.js"><link rel="prefetch" href="/assets/js/32.68859a3e.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/36.0a2188a4.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/39.eb7ebd4d.js"><link rel="prefetch" href="/assets/js/40.2b2b571a.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/47.3c660fb3.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_4.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="sidebar-link">/pieces/framework_7.html</a></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="active sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="sidebar-link">动机</a></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="动机"><a href="#动机" aria-hidden="true" class="header-anchor">#</a> 动机</h1><p>在研发中进场会碰到一些更改频率很低但是需要频繁访问的对象，比如：数据字典。这是缓存是最好的解决防范，Spring提供了一个通用的缓存框架Ehcache，那我为什么还要自己写一个呢？</p><ol><li>Spring ehcahe是一个通用的方案，他可以使用内存也可以使用磁盘，这是一个很好的优点，它拜托了内存大小的限制，但是会进行序列化导致性能降低。</li><li>如果一个对象集合同时需要list的形式存储已获得整体又需要以HashMap的形式组织以方便查询 Ehcache会缓存两次，所以我们需要一个缓存依赖关系。
鉴于以上原因我们设计了一个简单实用的缓存方案。</li></ol><h1 id="设计思想"><a href="#设计思想" aria-hidden="true" class="header-anchor">#</a> 设计思想</h1><p>做这个缓存方案主要目的是减少内存的消耗、增强缓存内容的访问效率。</p><ol><li>设计一个接口 ICachedObject&lt;T&gt; 它有一个是缓存失效的方法。</li><li>设计一个抽象类AbstractCachedObject&lt;T&gt; 它维护一个缓存依赖关系和当前缓存状态。</li><li>CachedObject&lt;T&gt;类是一个缓存的最简单的实现，它需要一个生产者Supplier&lt;T&gt; 在缓存失效时刷新数据，缓存对象在初始化时总是失效的。另外缓存在初始化时可以 设置其依赖的其它缓存对象，一个缓存可以依赖多个其它缓存对象。</li><li>CachedMap&lt;K,T&gt;是按照键值缓存的对象，它和CachedObject&lt;Map&lt;K,T&gt;&gt;是不一样的，后者作为一个对象整体缓存，前者是按照key分别缓存，每个key的状态是不一样的。CachedMap需要个生产者Function&lt;K, T&gt;。</li><li>DerivativeCachedMap&lt;K, D ,T&gt;是针对CachedMap派生的缓存，它需要一个转换函数Function&lt;D, T&gt;。</li></ol><h1 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h1><pre class="language-java"><code><span class="token comment">// 定义缓存对象 ，需要提供刷新函数 this::reloadUserInfo</span>
<span class="token keyword">private</span> CachedObject<span class="token operator">&lt;</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>ExtSysUserInfo<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> allUserInfoCache <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">CachedObject</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>reloadUserInfo<span class="token punctuation">,</span>
            <span class="token comment">// 缓存数据的有效期</span>
            CodeRepositoryCache<span class="token punctuation">.</span>CACHE_FRESH_PERIOD_MINITES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 缓存刷新函数，一般也是访问数据库获取真正对象的函数            </span>
<span class="token keyword">protected</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>ExtSysUserInfo<span class="token punctuation">&gt;</span></span> <span class="token function">reloadUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">(</span>Connection conn <span class="token operator">=</span> <span class="token function">getDatabaseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> allUserInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> <span class="token operator">|</span>IOException  e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">// 定义一个派生缓存</span>
<span class="token keyword">private</span> CachedObject<span class="token operator">&lt;</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span>ExtSysUserInfo<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> codeToUserMapCache<span class="token operator">=</span>
		<span class="token comment">// 刷新函数</span>
        <span class="token keyword">new</span> <span class="token class-name">CachedObject</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 从其它缓存获取数据</span>
                List<span class="token generics function"><span class="token punctuation">&lt;</span>ExtSysUserInfo<span class="token punctuation">&gt;</span></span> userInfos <span class="token operator">=</span> allUserInfoCache<span class="token punctuation">.</span><span class="token function">getCachedTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>userInfos<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> ExtSysUserInfo<span class="token punctuation">&gt;</span></span> userCodeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>userInfos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span>ExtSysUserInfo userInfo <span class="token operator">:</span> userInfos <span class="token punctuation">)</span><span class="token punctuation">{</span>
                    userCodeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getUserCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> userCodeMap<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 依赖的缓存，可以是多个；派生缓存没有有效期，它随依赖的缓存失效而失效</span>
            allUserInfoCache<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用缓存，派生缓存的使用方法一样，CachedMap的使用参见源码 </span>
<span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>ExtSysUserInfo<span class="token punctuation">&gt;</span></span> <span class="token function">listAllUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> allUserInfoCache<span class="token punctuation">.</span><span class="token function">getCachedTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><h1 id="源码"><a href="#源码" aria-hidden="true" class="header-anchor">#</a> 源码</h1><p><a href="https://github.com/ndxt/centit-commons/tree/master/centit-utils/src/main/java/com/centit/support/common" target="_blank" rel="noopener noreferrer">ICachedObject.java AbstractCachedObject.java CachedObject.java CachedMap.java DerivativeCachedMap.java</a></p></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/framework_9.html" class="prev">
          /pieces/framework_9.html
        </a></span><span class="next"><a href="/pieces/lexer_java.html">
          动机
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/33.8bba4ee1.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
