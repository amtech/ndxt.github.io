<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>概述</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/40.2b2b571a.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/26.10a40be6.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/30.8c2f80d9.js"><link rel="prefetch" href="/assets/js/31.3881f235.js"><link rel="prefetch" href="/assets/js/32.68859a3e.js"><link rel="prefetch" href="/assets/js/33.8bba4ee1.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/36.0a2188a4.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/39.eb7ebd4d.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/47.3c660fb3.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="active sidebar-link">概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pieces/framework_3.html#源码" class="sidebar-link">源码</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_3.html#应用场景" class="sidebar-link">应用场景</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_3.html#表达式的范式说明" class="sidebar-link">表达式的范式说明</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_3.html#表达式示例" class="sidebar-link">表达式示例</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_3.html#权限表达式示例" class="sidebar-link">权限表达式示例</a></li></ul></li><li><a href="/pieces/framework_4.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="sidebar-link">/pieces/framework_7.html</a></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="sidebar-link">动机</a></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="概述"><a href="#概述" aria-hidden="true" class="header-anchor">#</a> 概述</h1><p>在业务调研中用户经常会说这个申请表需要你的上级领导审批、或者需要分管领导审批或者需要兄弟单位进行同行评审，面对这样的需求一半都是要写很多逻辑代码的，问题是用户这样的规则还经常变化，如何快速的面对这样的需求变更呢？框架研发了一个用户机构关系的计算引擎来解决这个问题。先腾业务研发框架在<a href="https://blog.csdn.net/code_fan/article/details/82865124" target="_blank" rel="noopener noreferrer">用户机构模型</a>的基础上设计了一个权限表达式来解决这问题。这个表达就是由一个<strong>机构表达式</strong>和<strong>人员过滤器</strong>组成的<strong>权限表达式</strong>。</p><h2 id="源码"><a href="#源码" aria-hidden="true" class="header-anchor">#</a> 源码</h2><ol><li>机构表示式源码 <a href="https://github.com/ndxt/centit-framework/blob/master/framework-core/src/main/java/com/centit/framework/components/SysUnitFilterEngine.java" target="_blank" rel="noopener noreferrer">SysUnitFilterEngine.java</a> 。</li><li>人员过滤器（权限表达式）源码<a href="https://github.com/ndxt/centit-framework/blob/master/framework-core/src/main/java/com/centit/framework/components/SysUserFilterEngine.java" target="_blank" rel="noopener noreferrer">SysUserFilterEngine.java</a> 。</li></ol><p>更多源码和开源项目参见<a href="https://ndxt.github.io/" target="_blank" rel="noopener noreferrer">先腾开源框架</a>。</p><h2 id="应用场景"><a href="#应用场景" aria-hidden="true" class="header-anchor">#</a> 应用场景</h2><p>主要用于业务流程中的人员自动分配部分，比如：请假需要直接领导人（ D(u)R(r-1) ）审批还是部门最高责任人（ D(u)R(0-1) ）审批。 具体示例参见文档的最后部分。</p><h1 id="机构表达式"><a href="#机构表达式" aria-hidden="true" class="header-anchor">#</a> 机构表达式</h1><h2 id="表达式的范式说明"><a href="#表达式的范式说明" aria-hidden="true" class="header-anchor">#</a> 表达式的范式说明</h2><p>机构表达式中的所有变量、常量和运算结果都是一个集合，表达式形式如下：</p><ol><li><strong>常量</strong>：empty （空）| all （所有机构）|  “机构代码”（引号引起来的字符串，是机构的主键） ；</li><li><strong>变量</strong>：标识符；变量在表达式运算时用一个map传入表达式的计算上下文中。</li><li><strong>数值</strong>：层次； 是机构数的上下层次关系，只能用户计算的过程中。</li><li><strong>操作符</strong>：+ （下层机构，层次由后面的数值决定） | - （上层机构）| * （最上层机构的下层机构 ,± 的层次是相对当前的机构来计算的，* 的层次是相对当前机构的最上层机构来计算的）</li><li><strong>简单表达式</strong> ：变量|常量 | 常量 + 数值|  变量 *|+ 数值 |  变量 - 数值 + 数值</li><li><strong>机构表达式</strong> ： 简单表达式 | （机构表达式） |  机构表达式 || 机构表达式 | 机构表达式 &amp;&amp; 机构表达式 | 机构表达式 ! 机构表达式 | S(机构表达式[,机构表达式]+)</li><li><strong>机构过滤器</strong> D(机构表达式) ； 这个形式主要目的是和后面的人员过滤器一致起来； D 表示 department的意思。</li></ol><ul><li>机构表达式的结果是一个机构集合，||、&amp;&amp;、！均为集合运算符，||是取两个集合的并集，&amp;&amp;取两个集合的交集，！是在前一个集合中减去后一个集合。</li><li>S(机构表达式[,机构表达式]+) ，这个表达式表示返回多个表达式中的 第一个结果不为空的集合</li></ul><h2 id="表达式示例"><a href="#表达式示例" aria-hidden="true" class="header-anchor">#</a> 表达式示例</h2><p>示例中的表达式基于下面的机构数，下图的每一个方框表示一个机构，方框中的代码是机构代码。假设计算是传入一个变量dep 对应的值是&quot;D111&quot;。
<img src="https://img-blog.csdn.net/20180929185540204?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NvZGVfZmFu/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="机构树形图">
表达式示例：</p><ol><li>U(empty)=&gt;  ；返回空集合</li><li>U(all) =&gt; D1,D2,D11,D12,D111,D112,D1111,D1112 ；返回一个全部机构的集合</li><li>U(“D12”) =&gt;D12 ； 一个常量</li><li>U(empty+1) =&gt;D1,D2; 顶层机构</li><li>U(all+1) =&gt; D11,D12,D111,D112,D1111,D1112 ；非顶层机构，等价于 U(!(empty+1))</li><li>U(empty-1)=&gt; D2,D12,D112,D1111,D1112 ；所有叶子机构</li><li>U(all-1) =&gt; D1,D11,D111；所有非叶子机构，等价于 U(!(empty-1))</li><li>U(dep) =&gt; D111 ；变量直接对应的机构</li><li>U(dep+1) =&gt; D1111,D1112; 下级机构</li><li>U(dep-1) =&gt; D11； 上级机构</li><li>U(dep-1+1) =&gt; D111,D112；所有同级机构</li><li>U(dep*1) =&gt; D1；包含dep机构的顶层机构</li><li>U(dep-1+1 ! dep) =&gt; D112；兄弟单位，就是和自己同级的机构去除掉自己</li></ol><p>通过这个机构表达式可以计算，机构变量之间的相对关系，集合交集、并集和非的集合运算符可以应对大多数需求。</p><h1 id="人员过滤器"><a href="#人员过滤器" aria-hidden="true" class="header-anchor">#</a> 人员过滤器</h1><p>有了机构表达式定位到机构，再根据人员的岗位、行政职务和行政职务的等级计算关系，就可以对人员进行过滤了。人员过滤器的形式如下：</p><pre><code> **D**/**P**(机构表达式)**gw**(岗位过滤器)**xz**(行政职务过滤器)**R**(行政职务等级过滤器)**U**(人员代码过滤器) 
 5个部分，每一部分都不是必须的，每一个部分的解释如下：
</code></pre><ol><li><p><strong>D</strong>/<strong>P</strong>(机构表达式) 就是上面的记过过滤器，如果是P表示只考虑默认在这个机构中的人，这样机构和人员的关系就是一对多的关系了。</p></li><li><p><strong>gw</strong>(岗位过滤器) ； 括号中为 岗位代码集合用“，”分割，可以是字符串常量也可以是map中的变量</p></li><li><p><strong>xz</strong>(行政职务过滤器)；和岗位一样，对应的是行政职务代码。</p></li><li><p><strong>R</strong>(行政职务等级过滤器)；这个比较复杂，在框架的行政等级中数值越大等级越大，最高等级为1，所以+是下级，-是上级。它有以下几个形式</p><pre><code> *  R(r1) ；r1 可以是变量，也可以是常量，表示等级为r1的人，同一个等级可能对应多个行政职务。
 *  R(r1-1) ; r1 的上一级，因为一个机构中的人的等级不一定是连续的，所以他会找和 r1-1最接近的人，- 运算会向上找。
 *  R(r1+2)；r1的下两级，同样它会找和r1+2最接近的人，+运算会向下找。
 *  R(r1--)；比r1等级高的所有人
 *  R(r1++)；比r1等级低的所有人
 *  R(r1-1--)；比r1-1等级高的所有人
 *  R(r1+1++)；比r1+1等级低的所有人
</code></pre></li><li><p><strong>U</strong>(人员代码过滤器) ；和岗位类似，对应的是人员代码；这个一般独立使用，因为它已经定位到某个具体的人。</p></li></ol><h1 id="权限表达式"><a href="#权限表达式" aria-hidden="true" class="header-anchor">#</a> 权限表达式</h1><p><strong>权限表达式</strong> ：简单表达式 | S(权限表达式[,权限表达式]+) | （权限表达式） |  权限表达式 || 权限表达式 | 权限表达式 &amp;&amp; 权限表达式 | 权限表达式 ! 权限表达式
这个就是上面简单表达式的集合运算。</p><h2 id="权限表达式示例"><a href="#权限表达式示例" aria-hidden="true" class="header-anchor">#</a> 权限表达式示例</h2><p>首先假设一组关于当前用户的变量，它的形式是一个map：
u ：用户代码
d ：用户所在机构代码
s ：用户岗位代码
rank :   用户行政职务代码
r : 用户行政职位对应的等级
示例：</p><ol><li>D(u)R(r-1) : 用户在本部门的直接领导；</li><li>D(u-1)R(0+1) : 用户上级部门等级最高的人，就是上级部门主管。</li><li>D(u*1)R(0+1) : 用户顶级级部门等级最高的人，就是分管领导。</li><li>gw(s)R(0+1)：同岗位（技术工种）中等级最高的人，一般是技术总管。</li></ol></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/framework_2.html" class="prev">
          概述
        </a></span><span class="next"><a href="/pieces/framework_4.html">
          概述
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/40.2b2b571a.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
