<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>动机</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/32.68859a3e.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/26.10a40be6.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/30.8c2f80d9.js"><link rel="prefetch" href="/assets/js/31.3881f235.js"><link rel="prefetch" href="/assets/js/33.8bba4ee1.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/36.0a2188a4.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/39.eb7ebd4d.js"><link rel="prefetch" href="/assets/js/40.2b2b571a.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/47.3c660fb3.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_4.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="sidebar-link">/pieces/framework_7.html</a></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="active sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="sidebar-link">动机</a></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="动机"><a href="#动机" aria-hidden="true" class="header-anchor">#</a> 动机</h1><p>项目研发过程中经常会需要将业务逻辑外置，需要将业务逻辑和代码分离。一般面对这样的需求有以下几种解决办法：</p><ul><li>引入一个规则引擎，比如Drools。</li><li>利用java的javax.script.ScriptEngineManager调用javascript脚本。</li><li>利用antlr这样的开源项目定义自己的业务领域语言。
笔者在开发过程中经常需要对字符串进行分析，比如：从一个字符串中取出第一个符合标识符的单词;所以决定自己写一个词法分析器（Lexer），有了词法分析器后觉得写一个四则运算也非常简单，这样在<a href="https://ndxt.github.io" target="_blank" rel="noopener noreferrer">先腾框架（我的主要工作）</a>就用这个四则运算作为规则引擎。虽然不像drools那么强大，但使用也算比较方便，并且经过项目的验证也算够用。词法分析器<a href="https://github.com/ndxt/centit-commons/tree/master/centit-compiler" target="_blank" rel="noopener noreferrer">参见相关源码</a>。</li></ul><h1 id="词法分析器lexer"><a href="#词法分析器lexer" aria-hidden="true" class="header-anchor">#</a> 词法分析器Lexer</h1><p>虽然我们可以使用正则表达式来分析字符串，但是如果我们想从一个字符串或者文本文件中一个单词一个单词的分析，词法分析器是最合适的。一个词法分析器需要对应一个词法规则，设计在词法分析器遵循java和sql的词法，两个差别主要在注释方便，构造函数中需要区分。</p><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token function">Lexer</span><span class="token punctuation">(</span>String sFormula<span class="token punctuation">,</span><span class="token keyword">int</span> langType<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>languageType <span class="token operator">=</span> langType<span class="token punctuation">;</span>
        <span class="token function">setFormula</span><span class="token punctuation">(</span>sFormula<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>词法分析器的核心函数是 public String getAWord( ); 它返回的内容可能是：</p><ul><li>一个标识符，变量或者内置函数。</li><li>一个字符串。</li><li>一个操作符。</li></ul><pre class="language-java"><code><span class="token keyword">public</span> String <span class="token function">getARawWord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">int</span> sl <span class="token operator">=</span> formulaSen<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos <span class="token operator">&lt;</span> sl <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">' '</span> <span class="token operator">||</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">9</span> <span class="token operator">||</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token operator">||</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span> startPos<span class="token operator">++</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>startPos <span class="token operator">&gt;=</span> sl<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
       <span class="token keyword">int</span> bp <span class="token operator">=</span> startPos<span class="token punctuation">;</span>
       <span class="token comment">// 数字</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token string">'0'</span> <span class="token operator">&amp;&amp;</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'9'</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
           <span class="token comment">//m_Formula.charAt(m_iStart)== '.' ||</span>
           <span class="token punctuation">(</span> <span class="token operator">!</span> canAcceptOpt <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span> <span class="token string">'-'</span> <span class="token operator">||</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span> <span class="token string">'+'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
           startPos<span class="token operator">++</span><span class="token punctuation">;</span>
           <span class="token keyword">int</span> nPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span> startPos <span class="token operator">&lt;</span> sl  <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
                   <span class="token punctuation">(</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token string">'0'</span> <span class="token operator">&amp;&amp;</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'9'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                    formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'.'</span>  <span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span> 
               <span class="token keyword">if</span><span class="token punctuation">(</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'.'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
                   nPoints <span class="token operator">++</span><span class="token punctuation">;</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>nPoints<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>
                       <span class="token keyword">break</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               startPos <span class="token operator">++</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           canAcceptOpt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            
       <span class="token comment">// 标识符    </span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token string">'a'</span> <span class="token operator">&amp;&amp;</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'z'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
           <span class="token punctuation">(</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token string">'A'</span> <span class="token operator">&amp;&amp;</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'Z'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
           formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'_'</span> <span class="token operator">||</span>
           formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'@'</span>  <span class="token punctuation">)</span><span class="token punctuation">{</span>
           startPos<span class="token operator">++</span><span class="token punctuation">;</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span> startPos <span class="token operator">&lt;</span> sl  <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
                   <span class="token punctuation">(</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token string">'0'</span> <span class="token operator">&amp;&amp;</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'9'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                   <span class="token punctuation">(</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token string">'a'</span> <span class="token operator">&amp;&amp;</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'z'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                   <span class="token punctuation">(</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token string">'A'</span> <span class="token operator">&amp;&amp;</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'Z'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                     formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'_'</span> <span class="token operator">||</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'.'</span> <span class="token operator">||</span>
                     formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'@'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> 
               startPos <span class="token operator">++</span><span class="token punctuation">;</span>
           canAcceptOpt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
           canAcceptOpt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
           <span class="token keyword">switch</span><span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">case</span> <span class="token string">'+'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'+'</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">case</span> <span class="token string">'-'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'-'</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">case</span> <span class="token string">'*'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span>   <span class="token punctuation">)</span> <span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>    
           <span class="token keyword">case</span> <span class="token string">'/'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'*'</span><span class="token punctuation">)</span>   <span class="token punctuation">)</span> <span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>    
               
           <span class="token keyword">case</span> <span class="token string">'&lt;'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'&gt;'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'&lt;'</span><span class="token punctuation">)</span>   <span class="token punctuation">)</span> <span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>    
           <span class="token keyword">case</span> <span class="token string">'&gt;'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
                                    <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'&gt;'</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">case</span> <span class="token string">':'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
               
           <span class="token keyword">case</span> <span class="token string">'='</span><span class="token operator">:</span>
           <span class="token keyword">case</span> <span class="token string">'!'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">case</span> <span class="token string">'|'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">case</span> <span class="token string">'&amp;'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startPos<span class="token operator">&lt;</span>sl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">case</span> <span class="token string">'\&quot;'</span><span class="token operator">:</span> <span class="token comment">//字符串</span>
           <span class="token keyword">case</span> <span class="token string">'\''</span><span class="token operator">:</span> <span class="token comment">//字符串</span>
               canAcceptOpt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
               startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">case</span> <span class="token string">'.'</span><span class="token operator">:</span>
               <span class="token operator">++</span>startPos<span class="token punctuation">;</span>
               <span class="token keyword">while</span> <span class="token punctuation">(</span> startPos <span class="token operator">&lt;</span> sl  <span class="token operator">&amp;&amp;</span> 
                       <span class="token punctuation">(</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token string">'0'</span> <span class="token operator">&amp;&amp;</span> formulaSen<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startPos<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'9'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
               <span class="token punctuation">{</span> 
                   startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>                
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">case</span> <span class="token string">')'</span><span class="token operator">:</span>
               canAcceptOpt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
               startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//&quot;+-*/&quot;</span>
               startPos <span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       
       String str <span class="token operator">=</span> formulaSen<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> startPos <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> str<span class="token punctuation">;</span>    
   <span class="token punctuation">}</span>    
</code></pre><h1 id="带变量四则运算-variableformula"><a href="#带变量四则运算-variableformula" aria-hidden="true" class="header-anchor">#</a> 带变量四则运算 VariableFormula</h1><p>四则运行包括加减乘除、取模和与或非等等；表达式中的标识符对应的变量可以通过map传递给四则运算，也可以通过一个对象的属性传递。四则运算接口如下：</p><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">calculate</span><span class="token punctuation">(</span>String szExpress<span class="token punctuation">,</span>Object varMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre><p>变量对应的类型可以式任意类型，数字、字符串、日期、数组都可以。因为他们不仅可以传递到四则运行中还可以传递到四则运算的内置函数中。</p><h1 id="内置函数-embedfunc"><a href="#内置函数-embedfunc" aria-hidden="true" class="header-anchor">#</a> 内置函数 EmbedFunc</h1><p>为了对四则运行进行扩展，引入了内置函数来丰富表达式的功能。内置函数分一下几类：</p><ul><li>数学函数；比如：取整、开平方、对数等等。</li><li>字符串处理函数；查找子串、数字大写、补齐等等。</li><li>统计函数；求和、计数、统计非空数量等等。</li><li>日期函数；当前时间、时间的加减。</li><li>条件函数（逻辑函数）；if函数和case函数，不同的条件取对应的表达式结果。</li></ul><h1 id="测试与效果"><a href="#测试与效果" aria-hidden="true" class="header-anchor">#</a> 测试与效果</h1><p>测试代码</p><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testFormula3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token punctuation">&gt;</span></span> varMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        varMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        varMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String formula <span class="token operator">=</span> <span class="token string">&quot;(a*a-b)/b&quot;</span><span class="token punctuation">;</span>
        Object s <span class="token operator">=</span> VariableFormula<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span>formula<span class="token punctuation">,</span> varMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>StringBaseOpt<span class="token punctuation">.</span><span class="token function">castObjectToString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Done!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>运行结果</p><pre class="language-text"><code>24
Done!
</code></pre><p>词法分析器<a href="https://github.com/ndxt/centit-commons/tree/master/centit-compiler" target="_blank" rel="noopener noreferrer">参见相关源码</a>，更多先腾框架项目参见<a href="https://ndxt.github.io" target="_blank" rel="noopener noreferrer">先腾框架</a>。</p></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/huan_cun.html" class="prev">
          动机
        </a></span><span class="next"><a href="/pieces/multi_datasource.html">
          动机
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/32.68859a3e.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
