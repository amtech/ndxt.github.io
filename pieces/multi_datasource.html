<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>动机</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/31.3881f235.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/26.10a40be6.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/30.8c2f80d9.js"><link rel="prefetch" href="/assets/js/32.68859a3e.js"><link rel="prefetch" href="/assets/js/33.8bba4ee1.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/36.0a2188a4.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/39.eb7ebd4d.js"><link rel="prefetch" href="/assets/js/40.2b2b571a.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/47.3c660fb3.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_4.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="sidebar-link">/pieces/framework_7.html</a></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="active sidebar-link">动机</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pieces/multi_datasource.html#dynamicdatasource-设计思想" class="sidebar-link">DynamicDataSource 设计思想</a></li><li class="sidebar-sub-header"><a href="/pieces/multi_datasource.html#dynamicdatasource-使用步骤" class="sidebar-link">DynamicDataSource 使用步骤</a></li><li class="sidebar-sub-header"><a href="/pieces/multi_datasource.html#数据源描述-datasourcedescription" class="sidebar-link">数据源描述 DataSourceDescription</a></li><li class="sidebar-sub-header"><a href="/pieces/multi_datasource.html#动态数据源管理类dbcpconnectpools" class="sidebar-link">动态数据源管理类DbcpConnectPools</a></li><li class="sidebar-sub-header"><a href="/pieces/multi_datasource.html#事物执行框架-transactionhandler" class="sidebar-link">事物执行框架 TransactionHandler</a></li></ul></li><li><a href="/pieces/page_query_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="sidebar-link">动机</a></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="动机"><a href="#动机" aria-hidden="true" class="header-anchor">#</a> 动机</h1><p>业务系统中经常会需要同时操作多个数据库。常见的场景有：</p><ul><li>数据量太大，需要分表分库存储。</li><li>一些数据库操作类工具，比如：报表工具、自定义表单工具，需要随时添加和编辑数据源信息。</li></ul><p>对应的处理方法已有两种：</p><ul><li>对多个数据源是已知的、固定的，可以通过spring的AbstractRoutingDataSource类来实现数据库的路由。<a href="https://ndxt.github.io/" target="_blank" rel="noopener noreferrer">先腾框架</a>中<a href="https://github.com/ndxt/centit-persistence" target="_blank" rel="noopener noreferrer">持久化模块</a>中的<a href="https://github.com/ndxt/centit-persistence/tree/master/centit-persistence-core/src/main/java/com/centit/framework/core/datasource" target="_blank" rel="noopener noreferrer">动态数据源DynamicDataSource</a> 对AbstractRoutingDataSource进行了封装，并通过AOP 的方式用注解实现了数据源的路由。</li><li>对于数据源不确定的场景<a href="https://ndxt.github.io/" target="_blank" rel="noopener noreferrer">先腾框架</a>中的<a href="https://github.com/ndxt/centit-commons/blob/master/centit-database-datasource" target="_blank" rel="noopener noreferrer">数据基础操作模块</a>中的DbcpConnectPools对数据库链接池进行了封装，使得对数据源的操作根简单，并且提供了事务执行框架TransactionHandler.java。</li></ul><h1 id="动态数据源dynamicdatasource"><a href="#动态数据源dynamicdatasource" aria-hidden="true" class="header-anchor">#</a> 动态数据源DynamicDataSource</h1><h2 id="dynamicdatasource-设计思想"><a href="#dynamicdatasource-设计思想" aria-hidden="true" class="header-anchor">#</a> DynamicDataSource 设计思想</h2><p><strong>DynamicDataSource</strong> 动态数据源，通过对Spring的AbstractRoutingDataSource 的封装提供动态数据源获取支持。</p><blockquote><p><strong>原理：</strong></p><p><strong>DynamicDataSource</strong> 采用 AOP 机制拦截所有使用了注解 <code>@TargetDataSource(&quot;...&quot;)</code> 定义的类和方法，然后在此类中的方法和这些方法<strong>被调用之前自动切换</strong>当前数据源为 <code>@TargetDataSource(&quot;...&quot;)</code> 定义的数据源，为方法中使用提供适合的数据源（<code>org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource</code> 提供了多数据源注册和根据注册类型查找对应的数据源能力）。</p></blockquote><h2 id="dynamicdatasource-使用步骤"><a href="#dynamicdatasource-使用步骤" aria-hidden="true" class="header-anchor">#</a> DynamicDataSource 使用步骤</h2><h3 id="步骤1：-在spring配置文件中配置多个数据源。"><a href="#步骤1：-在spring配置文件中配置多个数据源。" aria-hidden="true" class="header-anchor">#</a> 步骤1： 在Spring配置文件中配置多个数据源。</h3><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.commons.dbcp2.BasicDataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.commons.dbcp2.BasicDataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.commons.dbcp2.BasicDataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.commons.dbcp2.BasicDataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="步骤2：-将这些数据源注册给"><a href="#步骤2：-将这些数据源注册给" aria-hidden="true" class="header-anchor">#</a> 步骤2： 将这些数据源注册给</h3><p><code>com.centit.framework.core.datasource.DynamicDataSource</code></p><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dynamic_datasource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.centit.framework.core.datasource.DynamicDataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 注册目标多个数据源 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>targetDataSources<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>map</span> <span class="token attr-name">key-type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>java.lang.String<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		   <span class="token comment">&lt;!--这里的key值将是 @TargetDataSource(&quot;...&quot;) 的值--&gt;</span>  
		   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds0<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span> 
		   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
		   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
		   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds3<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>map</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 如果出现了未知的数据源，则将使用这里配置的默认数据源替代 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>defaultTargetDataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ds1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="步骤3：-配置生效-dynamicdatasourceaspect-aop切面拦截器。"><a href="#步骤3：-配置生效-dynamicdatasourceaspect-aop切面拦截器。" aria-hidden="true" class="header-anchor">#</a> 步骤3： 配置生效 <code>DynamicDataSourceAspect</code> AOP切面拦截器。</h3><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dynamicDataSourceAspect<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.centit.framework.core.datasource.DynamicDataSourceAspect<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="步骤4：-使用注解-targetdatasource-定义类或方法要用到的数据源即可。"><a href="#步骤4：-使用注解-targetdatasource-定义类或方法要用到的数据源即可。" aria-hidden="true" class="header-anchor">#</a> 步骤4： 使用注解 <code>@TargetDatasource(&quot;...&quot;)</code> 定义类或方法要用到的数据源即可。</h3><p>注解定义在类上，类中的所有方法都使用这个数据源。</p><pre class="language-java"><code><span class="token comment">/** 
 * use on class, all methods in this class will be use 'ds1' datasource.
 */</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TargetDataSource</span><span class="token punctuation">(</span><span class="token string">&quot;ds1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">findUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>注解定义在方法上，这个方法使用这个数据源。</p><pre class="language-java"><code><span class="token comment">/** 
 * use on method, the method will be use 'ds4' datasource.
 */</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;orderService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@TargetDataSource</span><span class="token punctuation">(</span><span class="token string">&quot;ds4&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>OrderItem<span class="token punctuation">&gt;</span></span> <span class="token function">findOrderItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>根据参数动态的计算模板库，需要将mapByParameter 设置为true，value中的值为<a href="https://blog.csdn.net/code_fan/article/details/81352458" target="_blank" rel="noopener noreferrer">四则运算表达式</a>。</p><pre class="language-java"><code><span class="token comment">/** 
 * 根据参数动态的计算数据源
 */</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;shoppingCartService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingCartService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>ShoppingItem<span class="token punctuation">&gt;</span></span> <span class="token function">findShoppingItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>    

    <span class="token annotation punctuation">@TargetDataSource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;'ds'+ (userId mod 4 + 1)&quot;</span><span class="token punctuation">,</span> mapByParameter <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Address <span class="token function">getDefaultDeliverAddress</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1 id="动态链接池管理-dbcpconnectpools"><a href="#动态链接池管理-dbcpconnectpools" aria-hidden="true" class="header-anchor">#</a> 动态链接池管理 DbcpConnectPools</h1><p>动态连接池管理通过三个类实现：</p><h2 id="数据源描述-datasourcedescription"><a href="#数据源描述-datasourcedescription" aria-hidden="true" class="header-anchor">#</a> 数据源描述 DataSourceDescription</h2><p>数据源通过数据的jdbc-url和用户名唯一确定，就是同一个url不同的用户也是认为不同的数据源的。每个数据源可以有自己的不同的配置信息。</p><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceDescription</span> <span class="token keyword">implements</span>  <span class="token class-name">Serializable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> String connUrl <span class="token punctuation">;</span>
    <span class="token keyword">private</span> String username <span class="token punctuation">;</span>
    <span class="token keyword">private</span> String driver <span class="token punctuation">;</span>
    <span class="token keyword">private</span> String password <span class="token punctuation">;</span>
    <span class="token keyword">private</span> DBType dbType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span>    maxTotal <span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span>    maxIdle <span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span>    minIdle <span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span>    maxWaitMillis<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span>    initialSize <span class="token punctuation">;</span>
    <span class="token keyword">private</span> String databaseCode<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object dbco<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre><h2 id="动态数据源管理类dbcpconnectpools"><a href="#动态数据源管理类dbcpconnectpools" aria-hidden="true" class="header-anchor">#</a> 动态数据源管理类DbcpConnectPools</h2><p>这个类管理所有的数据源链接池；获取数据库链接式只需要调用 getDbcpConnect 方法就可以。</p><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> Connection <span class="token function">getDbcpConnect</span><span class="token punctuation">(</span>DataSourceDescription dsDesc<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> SQLException<span class="token punctuation">{</span>
        BasicDataSource ds <span class="token operator">=</span> dbcpDataSourcePools<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dsDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ds<span class="token operator">==</span>null<span class="token punctuation">)</span>
            ds <span class="token operator">=</span> <span class="token function">addDataSource</span><span class="token punctuation">(</span>dsDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Connection conn <span class="token operator">=</span> null<span class="token punctuation">;</span>
        conn <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">///*dsDesc.getUsername(),dsDesc.getDbType(),*/</span>
        <span class="token keyword">return</span> conn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><h2 id="事物执行框架-transactionhandler"><a href="#事物执行框架-transactionhandler" aria-hidden="true" class="header-anchor">#</a> 事物执行框架 TransactionHandler</h2><p>这个类只提供了一个方法executeInTransaction使用也很简单：</p><pre class="language-java"><code><span class="token keyword">public</span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runInTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        DataSourceDescription dbc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbc<span class="token punctuation">.</span><span class="token function">setConnUrl</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:oracle:thin:@192.168.131.81:1521:orcl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbc<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;fdemo2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbc<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;fdemo2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 假设这个对象是你要保存的; 如果调用 OrmDaoUtils.saveNewObject 成功，这个对象上必须有jpa注解
         * 有jpa注解就不用自己写sql语句了，否则自己写insert语句也是可以的
         */</span>
        Object userInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Integer ret <span class="token operator">=</span> TransactionHandler<span class="token punctuation">.</span><span class="token function">executeInTransaction</span><span class="token punctuation">(</span>dbc<span class="token punctuation">,</span> <span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * 这两个操作是在一个事物中的
                 */</span>
                DatabaseAccess<span class="token punctuation">.</span><span class="token function">doExecuteSql</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token string">&quot;delete from table where a=? and b=?&quot;</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> OrmDaoUtils<span class="token punctuation">.</span><span class="token function">saveNewObject</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><h1 id="源码"><a href="#源码" aria-hidden="true" class="header-anchor">#</a> 源码</h1><ul><li><a href="https://ndxt.github.io/" target="_blank" rel="noopener noreferrer">先腾框架</a>中<a href="https://github.com/ndxt/centit-persistence" target="_blank" rel="noopener noreferrer">持久化模块</a>。</li><li><a href="https://ndxt.github.io/" target="_blank" rel="noopener noreferrer">先腾框架</a>中的<a href="https://github.com/ndxt/centit-commons/blob/master/centit-database-datasource" target="_blank" rel="noopener noreferrer">数据基础操作模块</a>。</li></ul></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/lexer_java.html" class="prev">
          动机
        </a></span><span class="next"><a href="/pieces/page_query_1.html">
          动机
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/31.3881f235.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
