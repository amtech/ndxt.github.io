<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>概述</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/39.eb7ebd4d.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/26.10a40be6.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/30.8c2f80d9.js"><link rel="prefetch" href="/assets/js/31.3881f235.js"><link rel="prefetch" href="/assets/js/32.68859a3e.js"><link rel="prefetch" href="/assets/js/33.8bba4ee1.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/36.0a2188a4.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/40.2b2b571a.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/47.3c660fb3.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_4.html" class="active sidebar-link">概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pieces/framework_4.html#业务功能访问控制" class="sidebar-link">业务功能访问控制</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_4.html#业务范围访问控制" class="sidebar-link">业务范围访问控制</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_4.html#业务入口" class="sidebar-link">业务入口</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_4.html#页面显示" class="sidebar-link">页面显示</a></li></ul></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="sidebar-link">/pieces/framework_7.html</a></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="sidebar-link">动机</a></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="概述"><a href="#概述" aria-hidden="true" class="header-anchor">#</a> 概述</h1><p>先腾框架的权限控制从控制点分两类：</p><ol><li>前端控制；前端页面显示和页面上的操作按钮的显示控制。</li><li>后端控制；后端业务访问控制。</li></ol><p>从控制的内容也分两类：</p><ol><li>功能控制；业务功能控制。比如：对某个业务的修改操作。</li><li>数据范围控制；业务操作数据范围控制。</li></ol><p>框架设计的时候是基于这样的假设：</p><ol><li>前后端式分离的，并且推荐前端都是静态文件，部署在http服务器上。</li><li>前端通过ajax请求对后端进行访问。</li></ol><p>所以，前端的访问控制是可以绕过去的，比如，你知道一个前端页面Url（通常是一个html文件），即使没有登录、没有权限你依然可以访问这个html，但是html中的如果有js访问后台是就会报没有权限。</p><h1 id="后段访问控制"><a href="#后段访问控制" aria-hidden="true" class="header-anchor">#</a> 后段访问控制</h1><p>后端访问控制包括对业务功能的访问控制，业务范围的访问控制。</p><h2 id="业务功能访问控制"><a href="#业务功能访问控制" aria-hidden="true" class="header-anchor">#</a> 业务功能访问控制</h2><p>框架是基于Spring MVC开发的，每一个业务一般都对应一个controller类，每一个业务都一个标识（optId）。每一个业务功能对应到这个controller类中的一个@RequestMapping标注的方法，一般用方法名来标识（optMethod）。对功能的控制就是对应RequestMapping中标注的url的访问控制。框架中所有的url采用restful的风格。<a href="https://github.com/ndxt/centit-framework/blob/master/framework-security" target="_blank" rel="noopener noreferrer">framework-security</a>中的<a href="https://github.com/ndxt/centit-framework/blob/master/framework-security/src/main/java/com/centit/framework/security/DaoAccessDecisionManager.java" target="_blank" rel="noopener noreferrer">DaoAccessDecisionManager</a>类实现了功能访问的控制，它首先通过url来匹配对应的业务操作的方法（optMethod），然后根据这个optCode来查找权限配置库获取所有具有这个权限的角色列表，再用这个列表和用户的角色列表对比，如果有交集说明用户有这个权限，否在没有。</p><p><strong>注 :</strong></p><ol><li><em>框架采用了Spring Security作为安全组件，Spring Security提供了四种注解，分别是@PreAuthorize , @PreFilter , @PostAuthorize 和 @PostFilter来对方法级别的访问进行控制。它虽然可以非常细粒度的控制权限，但是要硬编码在代码中，不太适用于政府类的OA系统。所以框架没有采用这中方式。</em></li><li><em>访问控制模块自己匹配url和方法的对应关系，spring mvc同样也做了一边，这个在效率上不是高效的，目前没有解决这个问题，目前的算法是将所有的url按照层次组织成一个树形结构，匹配的算法复杂度和数的层次有关，就是和url中的/个数有关，性能还是不错的，对业务几乎没有影响。</em></li></ol><h2 id="业务范围访问控制"><a href="#业务范围访问控制" aria-hidden="true" class="header-anchor">#</a> 业务范围访问控制</h2><p>业务范围的控制的主要式通过对数据库中的数据访问范围来实现的。它包括两个部分：查询和写入（包括增删改）。</p><p>数据范围控制比较复制，框架提供了一个统一的通用的解决办法，但这个方法只能用在关系数据库查询中，如果这个办法不能满足业务的需求，可以通过将数据范围权限转换为业务功能权限的方式解决。</p><h3 id="查询控制"><a href="#查询控制" aria-hidden="true" class="header-anchor">#</a> 查询控制</h3><p>数据查询的范围控制是通过<a href="https://blog.csdn.net/code_fan/article/details/81452933" target="_blank" rel="noopener noreferrer">参数驱动SQL</a>中的<strong>外部过滤条件</strong>实现的，框架在定义业务功能操作是同时定义了这个业务的数据范围过滤条件，用户在进入业务功能后可以获得自己对应的权限范围的过滤条件（可能有多个，区并集），将这个过滤条件传递给 参数驱动SQL 查询方法，返回的就是用户可以访问的数据。目前这个<strong>还没有通过aop的方式实现</strong>，所以需要在开发人员在需要范围控制的地方手动添加这个<strong>程式代码</strong>。</p><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;testCaseManager&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestCaseManagerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TestCaseManager</span> <span class="token punctuation">{</span>
    <span class="token comment">//业务代码optId</span>
    <span class="token keyword">public</span> String <span class="token function">getOptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;testCase&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 框架通用的服务，可以访问框架的配置信息</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">protected</span> GeneralService generalService<span class="token punctuation">;</span>
    <span class="token comment">// 业务对应的数据库访问到</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">protected</span> TestCaseDao testCaseDao<span class="token punctuation">;</span>
    <span class="token comment">// * @param ud 当前用户信息， 在Controller中可以通过 getLoginUser() 获取 </span>
    <span class="token comment">// 具体的业务操作，每一个业务操作有一个唯一的操作代码optCode</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> JSONArray <span class="token function">listObjectsAsJson</span><span class="token punctuation">(</span>CentitUserDetails ud<span class="token punctuation">,</span>
                                Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> filterMap<span class="token punctuation">,</span> PageDesc pageDesc<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 创建当权用户信息相关的上下文</span>
        DataPowerFilter dataPowerFilter <span class="token operator">=</span> generalService<span class="token punctuation">.</span><span class="token function">createUserDataPowerFilter</span><span class="token punctuation">(</span>ud<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将当前查询参数（一般是前台输入的参数）添加到这个用户信息中 </span>
        dataPowerFilter<span class="token punctuation">.</span><span class="token function">addSourceData</span><span class="token punctuation">(</span>filterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取用户权限范围过滤条件，getOptId() 获取当前业务ID， query为当前业务操作方法名 optMethod</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> generalService<span class="token punctuation">.</span><span class="token function">listUserDataFiltersByOptIDAndMethod</span><span class="token punctuation">(</span>
            ud<span class="token punctuation">.</span><span class="token function">getUserCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getOptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;query&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> DictionaryMapUtils<span class="token punctuation">.</span><span class="token function">mapJsonArray</span><span class="token punctuation">(</span> <span class="token comment">// 数据字典翻译工作</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>testCaseDao<span class="token punctuation">.</span><span class="token function">listObjectsAsJson</span><span class="token punctuation">(</span> <span class="token comment">// 执行数据驱动SQL查询, 具体的语句在框架中封装了</span>
            									<span class="token comment">// 这儿也可以直接调用 传入自定义的动态sql语句</span>
                dataPowerFilter<span class="token punctuation">.</span><span class="token function">getSourceData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 参数 : 当前用户相关参数（已包括查询信息）</span>
                filters<span class="token punctuation">,</span>                        <span class="token comment">// 用户数据范围权限过滤条件</span>
                pageDesc<span class="token punctuation">)</span><span class="token punctuation">,</span> TestCase<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="写入控制"><a href="#写入控制" aria-hidden="true" class="header-anchor">#</a> 写入控制</h3><p>写入控制同样也<strong>还没有通过aop的方式实现</strong>，所以需要在开发人员在需要范围控制的地方手动添加这个<strong>程式代码</strong>。对写入的检验可以把当前操作的对象作为数据库中的一条记录，用权限过滤表达式检验一下；对应的就是调用dataPowerFilter.checkObject 方法。完整的源码参见<a href>centit-persistence</a>。</p><pre class="language-java"><code>    <span class="token comment">//* @param ud 当前用户信息， 在Controller中可以通过 getLoginUser() 获取 </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">saveNewCase</span><span class="token punctuation">(</span>CentitUserDetails ud<span class="token punctuation">,</span> TestCase testCase<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 创建当权用户信息相关的上下文</span>
        DataPowerFilter dataPowerFilter <span class="token operator">=</span> generalService<span class="token punctuation">.</span><span class="token function">createUserDataPowerFilter</span><span class="token punctuation">(</span>ud<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取用户权限范围过滤条件，getOptId() 获取当前业务ID，  saveNew 为当前业务操作方法名 optMethod</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> generalService<span class="token punctuation">.</span><span class="token function">listUserDataFiltersByOptIDAndMethod</span><span class="token punctuation">(</span>
            ud<span class="token punctuation">.</span><span class="token function">getUserCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getOptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;saveNew&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> passed <span class="token operator">=</span> dataPowerFilter<span class="token punctuation">.</span><span class="token function">checkObject</span><span class="token punctuation">(</span>testCase<span class="token punctuation">,</span> filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>passed<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>testCaseDao<span class="token punctuation">.</span><span class="token function">saveNewObject</span><span class="token punctuation">(</span>testCase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> passed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><h1 id="前端访问控制"><a href="#前端访问控制" aria-hidden="true" class="header-anchor">#</a> 前端访问控制</h1><p>前端访问控制分为业务入口（菜单展示）和页面显示（操作权限）两部分。</p><h2 id="业务入口"><a href="#业务入口" aria-hidden="true" class="header-anchor">#</a> 业务入口</h2><p>和业务入口相关的一般包括：首页和菜单列表（业务导航栏）。根据用户所有的功能权限可以得到一个和这些权限对应的业务列表。这个类别是用户所有可操作的模块，对应的业务入口url就是用户所以可以访问的业务菜单。</p><p><strong>注</strong><em>1. 前台可以调用 /system/mainframe/menu 来获取用户的菜单列表</em>。
<em>2. 用户访问没有权限的业务url前端并不会拦截，但是只能访问对应的页面的静态页面，无法获取相关业务数据</em>。</p><h2 id="页面显示"><a href="#页面显示" aria-hidden="true" class="header-anchor">#</a> 页面显示</h2><p>如果需要对页面上的操作进行权限控制（比如：对只有查看没有修改权限的人，隐藏修改按钮）。后台提供了接口 /system/mainframe/checkuserpower/{optId}/{method} 来查询当前用户是否有这个业务操作方法的权限。关于页面显示控制有几点说明：</p><ol><li>在页面上通过ajax访问后台的方法来判断是否有对应的操作权限，并依次对页面组件进行重画。</li><li>在用户登录是获取用户所有的操作方法权限，保存在本地存储中，在页面展示时从本地获得数据对页面重画。</li><li>上面两种方法框架都提供的通用的方法。这两种方法用户具有的权限都是和用户登录时间点有关，如果在用户登录后后台管理员给用户的权限进行变更，用户必须重新登录才能生效。</li><li>和页面入口一样，页面显示也可以通过前端直接访问业务对应的操作方法url来绕过验证，但是后端的权限控制会返回403错误。</li></ol></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/framework_3.html" class="prev">
          概述
        </a></span><span class="next"><a href="/pieces/framework_5.html">
          概述
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/39.eb7ebd4d.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
