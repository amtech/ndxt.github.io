<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>VuePress</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/36.0a2188a4.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/26.10a40be6.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/30.8c2f80d9.js"><link rel="prefetch" href="/assets/js/31.3881f235.js"><link rel="prefetch" href="/assets/js/32.68859a3e.js"><link rel="prefetch" href="/assets/js/33.8bba4ee1.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/39.eb7ebd4d.js"><link rel="prefetch" href="/assets/js/40.2b2b571a.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/47.3c660fb3.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_4.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="active sidebar-link">/pieces/framework_7.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pieces/framework_7.html#消息内容" class="sidebar-link">消息内容</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_7.html#接口messagesender" class="sidebar-link">接口MessageSender</a></li><li class="sidebar-sub-header"><a href="/pieces/framework_7.html#接口notificationcenter" class="sidebar-link">接口NotificationCenter</a></li></ul></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="sidebar-link">动机</a></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="概述"><a href="#概述" aria-hidden="true" class="header-anchor">#</a> 概述</h1><p>框架中提供的基础服务都是通过接口将实现和调用分离，这样应用开发人员可以根据业务的需求定制符合用户需求的实现方式。</p><p>系统中的消息分两种：</p><ol><li>信息，针对一个用户发送的信息，比如：待办提醒、日程提醒等待。</li><li>通知，针对一个群体，比如：部门、小组，的广播消息。</li></ol><p>框架中和通知相关的接口有两个：</p><ol start="4"><li>NotificationCenter 根据消息发送策略向用户发送消息。</li><li>MessageSender 真正的消息发送接口。</li></ol><h1 id="源码分析"><a href="#源码分析" aria-hidden="true" class="header-anchor">#</a> 源码分析</h1><h2 id="消息内容"><a href="#消息内容" aria-hidden="true" class="header-anchor">#</a> 消息内容</h2><p>消息内容可以是在线个用户发送的用户查看的信息，也可以是也前端应用改变状态的信息。消息内容可以和应用或者应用中的操作关联。</p><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoticeMessage</span> <span class="token keyword">implements</span> <span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 消息类别 默认值 msg
     * 客户端可以根据不同的消息类别提供不同的 响应方式 或者 展示方式
      */</span>
    <span class="token keyword">private</span> String msgType<span class="token punctuation">;</span>
    <span class="token comment">/** 消息主题 这不是必须的
     * */</span>
    <span class="token keyword">private</span> String msgSubject<span class="token punctuation">;</span>
    <span class="token comment">/** 消息内容，为一个文本，不同的消息类别 可以有不同的格式
     */</span>
    <span class="token keyword">private</span> String msgContent<span class="token punctuation">;</span>
    <span class="token comment">/** 关联业务
     */</span>
    <span class="token keyword">private</span> String optId<span class="token punctuation">;</span>
    <span class="token comment">/**关联业务中的 方法、功能、模块
     */</span>
    <span class="token keyword">private</span> String optMethod<span class="token punctuation">;</span>
    <span class="token comment">/** 关联对象组件，多个主键用url参数的方式链接
     */</span>
    <span class="token keyword">private</span> String optTag<span class="token punctuation">;</span>
</code></pre><h2 id="接口messagesender"><a href="#接口messagesender" aria-hidden="true" class="header-anchor">#</a> 接口MessageSender</h2><p><a href="https://github.com/ndxt/centit-framework/blob/master/framework-adapter/src/main/java/com/centit/framework/model/adapter/MessageSender.java" target="_blank" rel="noopener noreferrer">MessageSender</a> 只有一个需要实现的方法。它式真正发送消息的地方。</p><pre class="language-java"><code> <span class="token comment">/**
     * 发送内部系统消息
     *
     * @param sender     发送人内部用户编码
     * @param receiver   接收人内部用户编码
     * @param message 消息主体
     * @return &quot;OK&quot; 表示成功，其他的为错误信息
     */</span>
    String <span class="token function">sendMessage</span><span class="token punctuation">(</span> String sender<span class="token punctuation">,</span> String receiver<span class="token punctuation">,</span> NoticeMessage message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>框架中内置了一些具体的实现：</p><ol><li><a href="https://github.com/ndxt/centit-framework/blob/master/framework-core/src/main/java/com/centit/framework/components/impl/DummyMessageSenderImpl.java" target="_blank" rel="noopener noreferrer">DummyMessageSenderImpl</a>这个是一个哑实现，仅仅用于测试桩。</li><li><a href="https://github.com/ndxt/centit-framework/blob/master/framework-core/src/main/java/com/centit/framework/components/impl/EmailMessageSenderImpl.java" target="_blank" rel="noopener noreferrer">EmailMessageSenderImpl</a>是通过email发送消息的实现。</li><li>项目<a href="https://github.com/ndxt/centit-framework-system" target="_blank" rel="noopener noreferrer">centit-framework-system</a>中<a href="https://github.com/ndxt/centit-framework-system/blob/master/framework-system-module/src/main/java/com/centit/framework/system/service/impl/InnerMessageManagerImpl.java" target="_blank" rel="noopener noreferrer">InnerMessageManagerImpl.java</a>实现了一个通过数据库表来存储的内部消息机制。</li></ol><h2 id="接口notificationcenter"><a href="#接口notificationcenter" aria-hidden="true" class="header-anchor">#</a> 接口NotificationCenter</h2><p><a href="https://github.com/ndxt/centit-framework/blob/master/framework-adapter/src/main/java/com/centit/framework/model/adapter/NotificationCenter.java" target="_blank" rel="noopener noreferrer">NotificationCenter</a> 提供的发送消息的方式和接口MessageSender类似，额外多了写个消息发送注册接口，将方式方式（noticeType/sendType）和MessageSender 关联起来。NotificationCenter可以通过指定的方式给用户发送，也可以根据用户设置的接收方式发送，用户可以定义多个接收方式。默认情况下通过后者给用户发送消息。框架中也有多个实现：</p><ol><li><a href="https://github.com/ndxt/centit-framework/blob/master/framework-core/src/main/java/com/centit/framework/components/impl/SimpleNotificationCenterImpl.java" target="_blank" rel="noopener noreferrer">SimpleNotificationCenterImpl</a> 实现了唯一的发送方式的通知方案。</li><li><a href="https://github.com/ndxt/centit-framework/blob/master/framework-core/src/main/java/com/centit/framework/components/impl/NotificationCenterImpl.java" target="_blank" rel="noopener noreferrer">NotificationCenterImpl</a> 实现了可以根据用户设置接收方式的发送方案。</li><li>项目 <a href="https://github.com/ndxt/centit-msgpusher" target="_blank" rel="noopener noreferrer">centit-msgpusher</a> 中的<a href="https://github.com/ndxt/centit-msgpusher/blob/master/msgpusher-notification/src/main/java/com/centit/msgpusher/notification/SimpleNotificationCenterPlusMsgPusherImpl.java" target="_blank" rel="noopener noreferrer">SimpleNotificationCenterPlusMsgPusherImpl</a>在SimpleNotificationCenterImpl的基础上添加了对在线用户的websocket推送功能。使用这个功能需要引用msgpusher-notification 包。</li><li><a href="https://github.com/ndxt/centit-msgpusher" target="_blank" rel="noopener noreferrer">centit-msgpusher</a><a href="https://github.com/ndxt/centit-msgpusher/blob/master/msgpusher-notification/src/main/java/com/centit/msgpusher/notification/NotificationCenterPlusMsgPusherImpl.java" target="_blank" rel="noopener noreferrer">NotificationCenterPlusMsgPusherImpl</a>和上面的相似在NotificationCenterImpl的基础上添加了对在线用户的websocket推送功能。</li><li><a href="https://github.com/ndxt/centit-msgpusher" target="_blank" rel="noopener noreferrer">centit-msgpusher</a><a href="https://github.com/ndxt/centit-msgpusher/blob/master/msgpusher-client/src/main/java/com/centit/msgpusher/client/MsgPusherNotificationImpl.java" target="_blank" rel="noopener noreferrer">MsgPusherNotificationImpl</a>，这类是将消息发送的实现交给<a href="https://github.com/ndxt/centit-msgpusher/tree/master/msgpusher-server" target="_blank" rel="noopener noreferrer">msgpusher-server</a>服务，msgpusher-server可以通过websocket对pc在线用户发送消息，同时也可以对iOS和android用户实现实时的消息推送。使用这个功能需要引用msgpusher-client 包，同时要启动msgpusher-server服务，这个服务需要单独运行。</li></ol><h1 id="使用示例"><a href="#使用示例" aria-hidden="true" class="header-anchor">#</a> 使用示例</h1><p>使用通知中心，需要分四步：</p><ol><li>定义消息发送类的bean（实现MessageSender接口的bean），可以有多个、也可以没有 在使用msgpusher-server时就不需要。</li></ol><pre class="language-java"><code>	<span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> EmailMessageSenderImpl <span class="token function">emailMessageSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        EmailMessageSenderImpl sender <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmailMessageSenderImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sender<span class="token punctuation">.</span><span class="token function">setHostName</span><span class="token punctuation">(</span><span class="token string">&quot;mail.centit.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sender<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">&quot;suport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sender<span class="token punctuation">.</span><span class="token function">setUserPassword</span><span class="token punctuation">(</span><span class="token string">&quot;********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sender<span class="token punctuation">.</span><span class="token function">setServerEmail</span><span class="token punctuation">(</span><span class="token string">&quot;suport@centit.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sender<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><ol start="2"><li>定义个通知中心bean（实现NotificationCenter接口的bean）。</li></ol><pre class="language-java"><code>	<span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> NotificationCenter <span class="token function">notificationCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NotificationCenterImpl notificationCenter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NotificationCenterImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这个不是必须的,只是为了在没有真正的发送类时不报错</span>
        notificationCenter<span class="token punctuation">.</span><span class="token function">initDummyMsgSenders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//打开消息推送服务日志</span>
        notificationCenter<span class="token punctuation">.</span><span class="token function">setWriteNoticeLog</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> notificationCenter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><ol start="3"><li>在web初始化时将消息发送类的bean注册到通知中心bean中。</li></ol><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstantiationServiceBeanPostProcessor</span>
   <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics function"><span class="token punctuation">&lt;</span>ContextRefreshedEvent<span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">protected</span> NotificationCenter notificationCenter<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> EmailMessageSenderImpl emailMessageSender<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span>ContextRefreshedEvent event<span class="token punctuation">)</span><span class="token punctuation">{</span>
           notificationCenter<span class="token punctuation">.</span><span class="token function">registerMessageSender</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">,</span> emailMessageSender<span class="token punctuation">)</span><span class="token punctuation">;</span>
           notificationCenter<span class="token punctuation">.</span><span class="token function">appointDefaultSendType</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre><ol start="4"><li>在使用的地方引入 通知中心bean 。</li></ol><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">protected</span> NotificationCenter notificationCenter<span class="token punctuation">;</span>
</code></pre></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/framework_6.html" class="prev">
          /pieces/framework_6.html
        </a></span><span class="next"><a href="/pieces/framework_8.html">
          /pieces/framework_8.html
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/36.0a2188a4.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
