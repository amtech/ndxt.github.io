<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>动机</title>
    
    
    <link rel="preload" href="/assets/css/53.styles.73c7797a.css" as="style"><link rel="preload" href="/assets/js/app.2b7bf2f1.js" as="script"><link rel="preload" href="/assets/js/30.8c2f80d9.js" as="script"><link rel="prefetch" href="/assets/js/21.493656e1.js"><link rel="prefetch" href="/assets/js/0.8c6cb2b1.js"><link rel="prefetch" href="/assets/js/1.8d122193.js"><link rel="prefetch" href="/assets/js/2.da38c94d.js"><link rel="prefetch" href="/assets/js/3.7ba6dd4e.js"><link rel="prefetch" href="/assets/js/4.98f99baa.js"><link rel="prefetch" href="/assets/js/5.675307fa.js"><link rel="prefetch" href="/assets/js/6.0e2f11c8.js"><link rel="prefetch" href="/assets/js/7.59d873a0.js"><link rel="prefetch" href="/assets/js/8.606c9271.js"><link rel="prefetch" href="/assets/js/9.a25aea9f.js"><link rel="prefetch" href="/assets/js/10.2e240b38.js"><link rel="prefetch" href="/assets/js/11.69d46380.js"><link rel="prefetch" href="/assets/js/12.8666a845.js"><link rel="prefetch" href="/assets/js/13.fb9fa187.js"><link rel="prefetch" href="/assets/js/14.8cb80df4.js"><link rel="prefetch" href="/assets/js/15.3291b330.js"><link rel="prefetch" href="/assets/js/16.b051d1ed.js"><link rel="prefetch" href="/assets/js/17.a7e106c7.js"><link rel="prefetch" href="/assets/js/18.9d38a6f7.js"><link rel="prefetch" href="/assets/js/19.c5a8b8f0.js"><link rel="prefetch" href="/assets/js/20.b2b2e123.js"><link rel="prefetch" href="/assets/js/22.15a5ad8a.js"><link rel="prefetch" href="/assets/js/23.cd702e46.js"><link rel="prefetch" href="/assets/js/24.f6c597b9.js"><link rel="prefetch" href="/assets/js/25.6b4f6e65.js"><link rel="prefetch" href="/assets/js/26.10a40be6.js"><link rel="prefetch" href="/assets/js/27.cdfdf4a3.js"><link rel="prefetch" href="/assets/js/28.170fbd88.js"><link rel="prefetch" href="/assets/js/29.874f2874.js"><link rel="prefetch" href="/assets/js/31.3881f235.js"><link rel="prefetch" href="/assets/js/32.68859a3e.js"><link rel="prefetch" href="/assets/js/33.8bba4ee1.js"><link rel="prefetch" href="/assets/js/34.38351c6b.js"><link rel="prefetch" href="/assets/js/35.4efe87b7.js"><link rel="prefetch" href="/assets/js/36.0a2188a4.js"><link rel="prefetch" href="/assets/js/37.3197e625.js"><link rel="prefetch" href="/assets/js/38.d5a0ea00.js"><link rel="prefetch" href="/assets/js/39.eb7ebd4d.js"><link rel="prefetch" href="/assets/js/40.2b2b571a.js"><link rel="prefetch" href="/assets/js/41.39f09d33.js"><link rel="prefetch" href="/assets/js/42.423da9a7.js"><link rel="prefetch" href="/assets/js/43.91307f1b.js"><link rel="prefetch" href="/assets/js/44.457017c3.js"><link rel="prefetch" href="/assets/js/45.38dd7ecf.js"><link rel="prefetch" href="/assets/js/46.8c8ddb07.js"><link rel="prefetch" href="/assets/js/47.3c660fb3.js"><link rel="prefetch" href="/assets/js/48.2a80bd22.js"><link rel="prefetch" href="/assets/js/49.49314a9f.js"><link rel="prefetch" href="/assets/js/50.8c10f143.js"><link rel="prefetch" href="/assets/js/51.258a80e6.js"><link rel="prefetch" href="/assets/js/52.d4216a4c.js">
    <link rel="stylesheet" href="/assets/css/53.styles.73c7797a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/GUIDE.html" class="sidebar-link">/GUIDE.html</a></li><li><a href="/QandA.html" class="sidebar-link">常见问题及解决办法</a></li><li><a href="/" class="sidebar-link">/</a></li><li><a href="/UPDATE_LOG.html" class="sidebar-link">历史更新记录</a></li><li><a href="/pieces/data_drive_sql_1.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_3.html" class="sidebar-link">动机</a></li><li><a href="/pieces/data_drive_sql_4.html" class="sidebar-link">动机</a></li><li><a href="/pieces/framework_1.html" class="sidebar-link">适用场景</a></li><li><a href="/pieces/framework_10.html" class="sidebar-link">/pieces/framework_10.html</a></li><li><a href="/pieces/framework_11.html" class="sidebar-link">/pieces/framework_11.html</a></li><li><a href="/pieces/framework_2.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_3.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_4.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_5.html" class="sidebar-link">概述</a></li><li><a href="/pieces/framework_6.html" class="sidebar-link">/pieces/framework_6.html</a></li><li><a href="/pieces/framework_7.html" class="sidebar-link">/pieces/framework_7.html</a></li><li><a href="/pieces/framework_8.html" class="sidebar-link">/pieces/framework_8.html</a></li><li><a href="/pieces/framework_9.html" class="sidebar-link">/pieces/framework_9.html</a></li><li><a href="/pieces/huan_cun.html" class="sidebar-link">动机</a></li><li><a href="/pieces/lexer_java.html" class="sidebar-link">动机</a></li><li><a href="/pieces/multi_datasource.html" class="sidebar-link">动机</a></li><li><a href="/pieces/page_query_1.html" class="active sidebar-link">动机</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pieces/page_query_1.html#buildlimitquerysql" class="sidebar-link">buildLimitQuerySQL</a></li><li class="sidebar-sub-header"><a href="/pieces/page_query_1.html#buildgetcountsql" class="sidebar-link">buildGetCountSQL</a></li></ul></li><li><a href="/pieces/page_query_2.html" class="sidebar-link">动机</a></li><li><a href="/pieces/permutation_combination.html" class="sidebar-link">动机</a></li><li><a href="/pieces/sort_as_tree.html" class="sidebar-link">问题</a></li><li><a href="/pieces/spring_jdbc_jpa.html" class="sidebar-link">动机</a></li><li><a href="/projects/" class="sidebar-link">项目总体介绍</a></li><li><a href="/projects/centit-cas.html" class="sidebar-link">单点登录CAS</a></li><li><a href="/projects/centit-compiler.html" class="sidebar-link">表达式编译器</a></li><li><a href="/projects/centit-database.html" class="sidebar-link">数据库通用算法</a></li><li><a href="/projects/centit-dde.html" class="sidebar-link">数据交换工具</a></li><li><a href="/projects/centit-fileserver.html" class="sidebar-link">文件服务器</a></li><li><a href="/projects/centit-framework-cloud.html" class="sidebar-link">框架spring cloud版本</a></li><li><a href="/projects/centit-framework-system.html" class="sidebar-link">框架系统管理平台</a></li><li><a href="/projects/centit-framework.html" class="sidebar-link">研发框架</a></li><li><a href="/projects/centit-integration-platform.html" class="sidebar-link">集成平台</a></li><li><a href="/projects/centit-meta-form.html" class="sidebar-link">自定义表单服务</a></li><li><a href="/projects/centit-msgpusher.html" class="sidebar-link">消息推送服务</a></li><li><a href="/projects/centit-presistence.html" class="sidebar-link">数据库持久化公共类</a></li><li><a href="/projects/centit-scaffold.html" class="sidebar-link">代码脚手架</a></li><li><a href="/projects/centit-search.html" class="sidebar-link">全文检索类</a></li><li><a href="/projects/centit-stat.html" class="sidebar-link">统计报表服务</a></li><li><a href="/projects/centit-ui-easyui.html" class="sidebar-link">基于EasyUI的前段框架</a></li><li><a href="/projects/centit-ui-vue.html" class="sidebar-link">基于Vue的前段框架</a></li><li><a href="/projects/centit-utils.html" class="sidebar-link">基础算法类</a></li><li><a href="/projects/centit-webim.html" class="sidebar-link">即时通讯</a></li><li><a href="/projects/centit-workflow.html" class="sidebar-link">工作流引擎</a></li><li><a href="/projects/centit-workorder.html" class="sidebar-link">工单系统</a></li><li><a href="/system_design/" class="sidebar-link">框架的总体设计</a></li><li><a href="/system_design/concept_design.html" class="sidebar-link">概念设计</a></li><li><a href="/system_design/product_design.html" class="sidebar-link">产品设计</a></li><li><a href="/system_design/technical_design.html" class="sidebar-link">技术路线</a></li></ul></div><div class="page"><div class="content"><h1 id="动机"><a href="#动机" aria-hidden="true" class="header-anchor">#</a> 动机</h1><p>业务系统对数据库进行查询通常需要分页查询(否则数据量太大无法返回)，所以需要通用的分页查询。分页查询一般需要做两件事情：</p><ol><li>生成分页查询语句，进行分页查询。</li><li>生成求总数的语句，查询所有符合条件的数量，以求一共有多少页。</li></ol><p>在开发过程中能力强的程序员可以直接写这两个语句，作为<a href="https://ndxt.github.io/" target="_blank" rel="noopener noreferrer">先腾框架</a>提供了自动转换的函数，传入一个正常查询的语句，函数会自动转换为上述的两个语句。</p><h1 id="源码详解"><a href="#源码详解" aria-hidden="true" class="header-anchor">#</a> 源码详解</h1><p>所有源码参见<a href="https://github.com/ndxt/centit-commons/blob/master/centit-database/src/main/java/com/centit/support/database/utils/QueryUtils.java" target="_blank" rel="noopener noreferrer">QueryUtils</a>中的buildLimitQuerySQL 方法和buildGetCountSQL 方法。</p><h2 id="buildlimitquerysql"><a href="#buildlimitquerysql" aria-hidden="true" class="header-anchor">#</a> buildLimitQuerySQL</h2><p>不同的数据库分页方法是不一样的， 所有的方法都用到了<a href="https://blog.csdn.net/code_fan/article/details/81352458" target="_blank" rel="noopener noreferrer">编译原理中的lexer词法分析器</a>。</p><pre class="language-java"><code><span class="token comment">/* 参数 asParameter 表示分页参数 直接作为参数 还是直接 拼接到sql语句中 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">buildLimitQuerySQL</span><span class="token punctuation">(</span>String sql<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">int</span> maxsize<span class="token punctuation">,</span>
                                            <span class="token keyword">boolean</span> asParameter<span class="token punctuation">,</span> DBType dbType<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>dbType<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> Oracle<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">buildOracleLimitQuerySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span>offset<span class="token punctuation">,</span> maxsize<span class="token punctuation">,</span>asParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> DB2<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">buildDB2LimitQuerySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span>offset<span class="token punctuation">,</span> maxsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> SqlServer<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">buildSqlServerLimitQuerySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span>offset<span class="token punctuation">,</span> maxsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> MySql<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">buildMySqlLimitQuerySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span>offset<span class="token punctuation">,</span> maxsize<span class="token punctuation">,</span>asParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> H2<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">buildMySqlLimitQuerySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span>offset<span class="token punctuation">,</span> maxsize<span class="token punctuation">,</span>asParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> Access<span class="token operator">:</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PersistenceException</span><span class="token punctuation">(</span>PersistenceException<span class="token punctuation">.</span>ORM_METADATA_EXCEPTION<span class="token punctuation">,</span>
                        <span class="token string">&quot;不支持的数据库类型：&quot;</span><span class="token operator">+</span>dbType<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><h3 id="buildoraclelimitquerysql"><a href="#buildoraclelimitquerysql" aria-hidden="true" class="header-anchor">#</a> buildOracleLimitQuerySQL</h3><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">buildOracleLimitQuerySQL</span><span class="token punctuation">(</span>String sql<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">int</span> maxsize<span class="token punctuation">,</span><span class="token keyword">boolean</span> asParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> StringBuilder pagingSelect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span> sql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>asParameter<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token string">&quot;select * from ( select row_.*, rownum rownum_ from ( &quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token string">&quot;select * from ( &quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> sql <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token string">&quot; ) row_ ) where rownum_ &lt;= ? and rownum_ &gt; ?&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token string">&quot; ) where rownum &lt;= ?&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token string">&quot;select * from ( select row_.*, rownum rownum_ from ( &quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token string">&quot;select * from ( &quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> sql <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token string">&quot; ) row_ ) where rownum_ &lt;= &quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>offset <span class="token operator">+</span> maxsize<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; and rownum_ &gt; &quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                pagingSelect<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> <span class="token string">&quot; ) where rownum &lt;= &quot;</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>maxsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pagingSelect<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><h3 id="builddb2limitquerysql"><a href="#builddb2limitquerysql" aria-hidden="true" class="header-anchor">#</a> buildDB2LimitQuerySQL</h3><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">buildDB2LimitQuerySQL</span><span class="token punctuation">(</span>String sql<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">int</span> maxsize<span class="token comment">/*,boolean asParameter*/</span><span class="token punctuation">)</span>
        <span class="token comment">/*throws SQLException*/</span><span class="token punctuation">{</span>
        <span class="token comment">/*if(asParameter)*/</span>
            <span class="token comment">//throw new SQLException(&quot;DB2 unsupported parameter in fetch statement.&quot;);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> offset <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> maxsize<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">?</span>sql <span class="token operator">+</span> <span class="token string">&quot; fetch first &quot;</span> <span class="token operator">+</span> maxsize <span class="token operator">+</span> <span class="token string">&quot; rows only&quot;</span><span class="token operator">:</span>
                                   <span class="token string">&quot; fetch first 1 row only&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//nest the main query in an outer select</span>
        <span class="token keyword">return</span> <span class="token string">&quot;select * from ( select inner2_.*, rownumber() over(order by order of inner2_) as rownumber_ from ( &quot;</span>
                <span class="token operator">+</span> sql <span class="token operator">+</span> <span class="token string">&quot; fetch first &quot;</span> <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>offset<span class="token operator">+</span>maxsize<span class="token punctuation">)</span> 
                <span class="token operator">+</span> <span class="token operator">+</span> <span class="token string">&quot; rows only ) as inner2_ ) as inner1_ where rownumber_ &gt; &quot;</span>
                <span class="token operator">+</span> offset <span class="token operator">+</span> <span class="token string">&quot; order by rownumber_&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
</code></pre><h3 id="buildsqlserverlimitquerysql"><a href="#buildsqlserverlimitquerysql" aria-hidden="true" class="header-anchor">#</a> buildSqlServerLimitQuerySQL</h3><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">buildSqlServerLimitQuerySQL</span><span class="token punctuation">(</span>String sql<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">int</span> maxsize<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> offset <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// SQL SERVER 2012  才支持</span>
            String alias_list <span class="token operator">=</span> StringBaseOpt<span class="token punctuation">.</span><span class="token function">objectToString</span><span class="token punctuation">(</span> <span class="token function">getSqlFiledNames</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;WITH query AS (&quot;</span>
                     <span class="token operator">+</span><span class="token string">&quot;SELECT inner_query.* &quot;</span>
                     <span class="token operator">+</span><span class="token string">&quot;, ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) as __row_nr__ &quot;</span>
                     <span class="token operator">+</span><span class="token string">&quot; FROM ( &quot;</span> <span class="token operator">+</span> sql <span class="token operator">+</span> <span class="token string">&quot;) inner_query&quot;</span>
                     <span class="token operator">+</span><span class="token string">&quot; ) &quot;</span>
                     <span class="token operator">+</span><span class="token string">&quot; SELECT &quot;</span><span class="token operator">+</span> alias_list <span class="token operator">+</span><span class="token string">&quot; FROM query WHERE __row_nr__ &gt;=&quot;</span> <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
                     <span class="token operator">+</span> <span class="token string">&quot; AND __row_nr__ &lt; &quot;</span> <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>offset <span class="token operator">+</span> maxsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
               <span class="token keyword">int</span> selectIndex <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span> <span class="token string">&quot;select&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> selectDistinctIndex <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span> <span class="token string">&quot;select distinct&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            selectIndex <span class="token operator">=</span>  selectIndex <span class="token operator">+</span> <span class="token punctuation">(</span>selectDistinctIndex <span class="token operator">==</span> selectIndex <span class="token operator">?</span> <span class="token number">15</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span> sql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span> sql <span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> selectIndex<span class="token punctuation">,</span> <span class="token string">&quot; top &quot;</span> <span class="token operator">+</span> maxsize <span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><h3 id="buildmysqllimitquerysql"><a href="#buildmysqllimitquerysql" aria-hidden="true" class="header-anchor">#</a> buildMySqlLimitQuerySQL</h3><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">buildMySqlLimitQuerySQL</span><span class="token punctuation">(</span>String sql<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">int</span> maxsize<span class="token punctuation">,</span><span class="token keyword">boolean</span> asParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>asParameter<span class="token punctuation">)</span>
            <span class="token keyword">return</span> sql <span class="token operator">+</span> <span class="token punctuation">(</span>offset<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot; limit ?, ?&quot;</span> <span class="token operator">:</span> <span class="token string">&quot; limit ?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> sql <span class="token operator">+</span> <span class="token punctuation">(</span>offset<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot; limit &quot;</span><span class="token operator">+</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;,&quot;</span><span class="token operator">+</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>maxsize<span class="token punctuation">)</span> <span class="token operator">:</span>
                                     <span class="token string">&quot; limit &quot;</span><span class="token operator">+</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>maxsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><h2 id="buildgetcountsql"><a href="#buildgetcountsql" aria-hidden="true" class="header-anchor">#</a> buildGetCountSQL</h2><p>获取总数的语句转换有两种方式，一种比较保险的方法就是子查询方法，还有一种式将select语句替换为select count(*) 但是这个在有group分组时就不能正确返回结果了。附带码：</p><pre class="language-java"><code><span class="token comment">/**
     * 通过子查询来实现获取计数语句
     * @param sql sql 或者 hql 语句
     * @return sql
     */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">buildGetCountSQLBySubSelect</span><span class="token punctuation">(</span>String sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> sqlPieces <span class="token operator">=</span> <span class="token function">splitSqlByFields</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlPieces <span class="token operator">==</span> null <span class="token operator">||</span> sqlPieces<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sqlPieces<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;select&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//这个仅仅为了兼容hibernate</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sqlPieces<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot; * from&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; count(*) as rowCount from (select &quot;</span><span class="token operator">+</span>
            sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) a&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">/**
     * 将查询语句转换为相同条件的查询符合条件的记录数的语句, 需要考虑with语句
     * 即将 select 的字段部分替换为 count(*) 并去掉 order by排序部分
     * 对查询语句中有distinct的sql语句不使用
     * @param sql sql
     * @return sql
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">buildGetCountSQLByReplaceFields</span><span class="token punctuation">(</span>String sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> sqlPieces <span class="token operator">=</span> <span class="token function">splitSqlByFields</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlPieces <span class="token operator">==</span> null <span class="token operator">||</span> sqlPieces<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sqlPieces<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;select&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         
        String groupByField <span class="token operator">=</span> QueryUtils<span class="token punctuation">.</span><span class="token function">getGroupByField</span><span class="token punctuation">(</span>sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>groupByField<span class="token operator">==</span>null<span class="token punctuation">)</span>
             <span class="token keyword">return</span> sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; count(*) as rowcount from &quot;</span> <span class="token operator">+</span>
                     <span class="token function">removeOrderBy</span><span class="token punctuation">(</span>sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; count(*) as rowcount from (select &quot;</span><span class="token operator">+</span>
             groupByField  <span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> <span class="token function">removeOrderBy</span><span class="token punctuation">(</span>sqlPieces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) a&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/pieces/multi_datasource.html" class="prev">
          动机
        </a></span><span class="next"><a href="/pieces/page_query_2.html">
          动机
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/30.8c2f80d9.js" defer></script><script src="/assets/js/app.2b7bf2f1.js" defer></script>
  </body>
</html>
